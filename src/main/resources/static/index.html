<!--
Save this file as index.html

To run locally:
1. In a terminal, navigate to the folder containing this file.
2. Run: python3 -m http.server 8000
3. Open http://localhost:8000 in your browser.
Ensure your backend is running on http://localhost:3000
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Amino Acid Calculator</title>
    <style>
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
            margin: 0;
            padding: 1rem;
            max-width: 1100px;
            margin-left: auto;
            margin-right: auto;
            color: #0f172a;
            background: #f8fafc;
        }
        h1 {
            text-align: center;
            margin-bottom: 1rem;
            font-weight: 700;
        }
        .form-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
            position: relative;
        }
        .form-group input,
        .form-group button {
            font-size: 1rem;
        }
        .food-input {
            flex: 1 1 100%;
            padding: 0.5rem;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
        }
        .range-input {
            width: 5.2rem;
            padding: 0.5rem;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
        }
        button {
            cursor: pointer;
            padding: 0.6rem 1rem;
            border: none;
            background: #2563eb;
            color: white;
            border-radius: 6px;
            transition: background 0.15s ease;
        }
        button:hover { background: #1d4ed8; }
        button[disabled] {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .suggestions {
            border: 1px solid #94a3b8;
            border-top: none;
            position: absolute;
            background: white;
            width: calc(100% - 2px);
            max-height: 180px;
            overflow-y: auto;
            z-index: 1000;
            border-bottom-left-radius: 6px;
            border-bottom-right-radius: 6px;
            box-shadow: 0 6px 20px rgba(15, 23, 42, 0.08);
        }
        .suggestions div {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
        }
        .suggestions div:hover {
            background: #f1f5f9;
        }
        .results {
            margin-top: 2rem;
        }
        .result-card {
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1.25rem;
            background: white;
            box-shadow: 0 6px 18px rgba(2, 8, 23, 0.03);
        }
        .result-card h2 {
            margin: 0 0 0.75rem;
            font-size: 1.1rem;
            color: #0f172a;
        }
        table.combo-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            font-variant-numeric: tabular-nums;
            border-radius: 8px;
            overflow: hidden;
        }
        table.combo-table thead th {
            position: sticky;
            top: 0;
            z-index: 1;
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
            color: #334155;
            padding: 8px 10px;
            text-align: right;
            font-weight: 700;
            font-size: 0.9rem;
        }
        table.combo-table thead th:first-child { text-align: left; }
        table.combo-table thead th:nth-child(2) { text-align: right; }
        table.combo-table tbody td,
        table.combo-table tfoot td {
            border-bottom: 1px solid #e2e8f0;
            padding: 8px 10px;
            text-align: right;
            background: transparent; /* let row background show through */
        }
        /* Remove zebra striping so the whole row can have the same color dynamically */
        /* table.combo-table tbody tr:nth-child(odd) td { background: #fbfdff; } */
        table.combo-table td.food {
            text-align: left;
            font-weight: 600;
            color: #0f172a;
        }
        table.combo-table tfoot td {
            background: #f1f5f9;
            font-weight: 700;
        }
        .chip {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            background: #e2e8f0;
            color: #0f172a;
            font-size: 0.85rem;
            margin-left: 6px;
        }
        .error-banner {
            border: 1px solid #fecaca;
            background: #fef2f2;
            color: #b91c1c;
            padding: 10px 12px;
            border-radius: 8px;
            margin-bottom: 14px;
            font-weight: 600;
        }
        .invalid {
            border-color: #ef4444 !important;
            outline: none;
            box-shadow: 0 0 0 1px rgba(239,68,68,0.3);
        }
    </style>
</head>
<body>
<h1>Amino Acid Calculator</h1>
<div id="app">
    <div id="input-section">
        <div id="food-list"></div>
        <button id="add-food-btn">Add Food</button>
        <button id="calculate-btn">Calculate Combinations</button>
        <div id="limit-msg" class="error-banner" style="display:none;" role="status" aria-live="polite"></div>
        <div id="validation-msg" class="error-banner" style="display:none;" role="alert" aria-live="assertive"></div>
    </div>
    <div class="results" id="results-section"></div>
</div>
<script>
    const maxFoods = 10;
    let foodCount = 0;

    const foodListEl = document.getElementById('food-list');
    const addFoodBtn = document.getElementById('add-food-btn');
    const calculateBtn = document.getElementById('calculate-btn');
    const resultsSection = document.getElementById('results-section');
    const limitMsgEl = document.getElementById('limit-msg');
    const validationMsgEl = document.getElementById('validation-msg');

    // Track a unique index for each created group so removals don't break IDs
    let nextIdx = 0;

    function createFoodInputs() {
        if (foodCount >= maxFoods) {
            showLimitMessage();
            return;
        }
        const idx = nextIdx++;
        foodCount++;
        const container = document.createElement('div');
        container.className = 'form-group';
        container.id = `food-group-${idx}`;
        container.dataset.idx = String(idx);

        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.placeholder = 'Type food name';
        nameInput.className = 'food-input';
        nameInput.autocomplete = 'off';
        nameInput.addEventListener('input', debounce(e => { container.dataset.foodId = ''; fetchSuggestions(e.target.value, idx); }, 300));

        const suggestionsBox = document.createElement('div');
        suggestionsBox.id = `suggestions-${idx}`;
        suggestionsBox.style.display = 'none';
        suggestionsBox.className = 'suggestions';

        const minInput = document.createElement('input');
        minInput.type = 'number';
        minInput.step = '5';
        minInput.min = '0';
        minInput.placeholder = 'Min g';
        minInput.className = 'range-input';

        const maxInput = document.createElement('input');
        maxInput.type = 'number';
        maxInput.step = '5';
        maxInput.min = '0';
        maxInput.placeholder = 'Max g';
        maxInput.className = 'range-input';

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.textContent = 'Remove';
        removeBtn.style.background = '#ef4444';
        removeBtn.style.marginLeft = '0.5rem';
        removeBtn.title = 'Remove this food';
        removeBtn.addEventListener('click', () => {
            container.remove();
            foodCount = Math.max(0, foodCount - 1);
            // Re-enable Add button if we are below the limit now
            if (foodCount < maxFoods) {
                addFoodBtn.disabled = false;
                addFoodBtn.removeAttribute('title');
                if (limitMsgEl) limitMsgEl.style.display = 'none';
            }
        });

        container.append(nameInput, suggestionsBox, minInput, maxInput, removeBtn);
        foodListEl.appendChild(container);

        // If we just reached the limit, disable the Add button and inform the user
        if (foodCount >= maxFoods) {
            addFoodBtn.disabled = true;
            addFoodBtn.title = `Maximum of ${maxFoods} foods reached`;
            showLimitMessage(true);
        } else {
            addFoodBtn.disabled = false;
            addFoodBtn.removeAttribute('title');
        }
    }

    addFoodBtn.addEventListener('click', createFoodInputs);

    function debounce(fn, delay) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => fn(...args), delay);
        };
    }

    function showLimitMessage(reachedExactly = false) {
        if (!limitMsgEl) return;
        const msg = reachedExactly
            ? `Maximum of ${maxFoods} foods reached.`
            : `You can add up to ${maxFoods} foods.`;
        limitMsgEl.textContent = msg;
        limitMsgEl.style.display = 'block';
        // Auto-hide after 3 seconds
        clearTimeout(showLimitMessage._t);
        // @ts-ignore - attach timer id on function for simplicity
        showLimitMessage._t = setTimeout(() => {
            if (limitMsgEl) limitMsgEl.style.display = 'none';
        }, 3000);
    }

    async function fetchSuggestions(query, idx) {
        if (!query) {
            toggleSuggestions(idx, []);
            return;
        }
        try {
            const res = await fetch(`http://localhost:8080/api/foods?suggest=${encodeURIComponent(query)}`);
            const foods = await res.json();
            toggleSuggestions(idx, foods);
        } catch (err) {
            console.error(err);
        }
    }

    function toggleSuggestions(idx, foods) {
        const box = document.getElementById(`suggestions-${idx}`);
        box.innerHTML = '';
        if (!foods.length) {
            box.style.display = 'none';
            return;
        }
        foods.forEach(food => {
            const div = document.createElement('div');
            div.textContent = food.name;
            div.addEventListener('click', () => selectSuggestion(idx, food));
            box.appendChild(div);
        });
        box.style.display = 'block';
    }

    function selectSuggestion(idx, food) {
        const container = document.getElementById(`food-group-${idx}`);
        const nameInput = container.querySelector('input.food-input');
        nameInput.value = food.name;
        container.dataset.foodId = food.id;
        document.getElementById(`suggestions-${idx}`).style.display = 'none';
    }

    function clearValidation() {
        if (validationMsgEl) validationMsgEl.style.display = 'none';
        document.querySelectorAll('#food-list input').forEach(el => el.classList.remove('invalid'));
    }

    function showValidationMessage(msg) {
        if (!validationMsgEl) return;
        validationMsgEl.textContent = msg;
        validationMsgEl.style.display = 'block';
    }

    calculateBtn.addEventListener('click', async () => {
        clearValidation();
        const foods = [];
        const groups = document.querySelectorAll('#food-list .form-group');
        if (!groups.length) {
            showValidationMessage('Please add at least one food.');
            return;
        }
        let hasError = false;
        groups.forEach(container => {
            const id = container.dataset.foodId;
            const nameInput = container.querySelector('input.food-input');
            const minEl = container.querySelector('input[placeholder="Min g"]');
            const maxEl = container.querySelector('input[placeholder="Max g"]');
            const name = nameInput.value.trim();
            const minVal = minEl.value.trim();
            const maxVal = maxEl.value.trim();

            // Validate selection and integer values
            const min = Number(minVal);
            const max = Number(maxVal);
            const minInt = Number.isInteger(min);
            const maxInt = Number.isInteger(max);

            // Reset previous state
            nameInput.classList.remove('invalid');
            minEl.classList.remove('invalid');
            maxEl.classList.remove('invalid');

            let groupValid = true;
            if (!id) {
                groupValid = false;
                nameInput.classList.add('invalid');
            }
            if (minVal === '' || !minInt) {
                groupValid = false;
                minEl.classList.add('invalid');
            }
            if (maxVal === '' || !maxInt) {
                groupValid = false;
                maxEl.classList.add('invalid');
            }

            if (!groupValid) {
                hasError = true;
                return; // skip pushing this group
            }
            foods.push({ id, name, min, max });
        });

        if (hasError) {
            showValidationMessage('Please select a food and enter integer values for Min and Max for all rows.');
            return;
        }

        try {
            const res = await fetch('http://localhost:8080/api/calculate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ foods })
            });
            const results = await res.json();
            displayResults(results);
        } catch (err) {
            console.error(err);
            showValidationMessage('An error occurred while calculating. Please try again.');
        }
    });

    // Build and render a combination table from CombinationTableDto
    function renderCombinationTable(combo) {
        const table = document.createElement('table');
        table.className = 'combo-table';

        // Header: Food | Amount | Amino columns
        const thead = document.createElement('thead');
        const htr = document.createElement('tr');
        ['Food', 'Amount', ...combo.aminoColumns].forEach(label => {
            const th = document.createElement('th');
            th.textContent = label;
            htr.appendChild(th);
        });
        thead.appendChild(htr);
        table.appendChild(thead);

        // Color scale helper 0..1 => red→green
        function pctColor(p) {
            const t = Math.max(0, Math.min(1, p));
            const r = Math.round(255 * (1 - t));
            const g = Math.round(180 * t);
            return `rgb(${r},${g},120)`;
        }

        // Determine baseline for row coloring using PROTEIN share
        const maxRowProtein = combo.rows.reduce((m, r) => {
            const v = r.mgByAmino['PROTEIN'] || 0;
            return Math.max(m, v);
        }, 0);

        // Body rows
        const tbody = document.createElement('tbody');
        combo.rows.forEach(row => {
            const tr = document.createElement('tr');

            // Uniform row color based on protein proportion
            const rowProtein = row.mgByAmino['PROTEIN'] || 0;
            if (maxRowProtein > 0) {
                const p = rowProtein / maxRowProtein;
                tr.style.background = pctColor(p);
            }

            // Food name
            const tdf = document.createElement('td');
            tdf.className = 'food';
            tdf.textContent = row.name;
            tr.appendChild(tdf);

            // Amount with " g"
            const tdg = document.createElement('td');
            tdg.textContent = `${row.grams} g`;
            tr.appendChild(tdg);

            // Amino/protein values in grams with " g"
            combo.aminoColumns.forEach(a => {
                const mg = row.mgByAmino[a] ?? 0;
                const grams = mg / 1000;
                const td = document.createElement('td');
                td.textContent = `${grams.toFixed(2)} g`;
                tr.appendChild(td);
            });

            tbody.appendChild(tr);
        });
        table.appendChild(tbody);

        // Totals row
        const tfoot = document.createElement('tfoot');
        const trt = document.createElement('tr');

        // First column: "Total"
        const tlabel = document.createElement('td');
        tlabel.textContent = 'Total';
        trt.appendChild(tlabel);

        // Amount column: sum of grams with " g"
        const totalGrams = combo.rows.reduce((sum, r) => sum + (r.grams || 0), 0);
        const tAmount = document.createElement('td');
        tAmount.textContent = `${totalGrams} g`;
        trt.appendChild(tAmount);

        // Amino/protein totals in grams with " g" and % of daily minimum intake
        combo.aminoColumns.forEach(a => {
            const mg = combo.totals.totalMgByAmino[a] ?? 0;
            const grams = mg / 1000;
            const rdaMg = (combo.rdaMgByAmino && combo.rdaMgByAmino[a]) ? combo.rdaMgByAmino[a] : 0;
            const pct = rdaMg > 0 ? Math.round((mg / rdaMg) * 100) : 0;
            const td = document.createElement('td');
            td.textContent = `${grams.toFixed(2)} g (${pct}%)`;
            if (pct < 100) {
                td.style.color = '#b91c1c'; // highlight totals under minimum
                td.style.fontWeight = '700';
            }
            trt.appendChild(td);
        });

        tfoot.appendChild(trt);
        table.appendChild(tfoot);

        return table;
    }

    function displayResults(results) {
        resultsSection.innerHTML = '';

        // Show a friendly diagnostic message when backend returned max-grams fallback
        if (results.length === 1 && results[0].errorMessage) {
            const banner = document.createElement('div');
            banner.className = 'error-banner';
            banner.textContent = results[0].errorMessage;
            resultsSection.appendChild(banner);
        }

        results.forEach((combo, i) => {
            const card = document.createElement('div');
            card.className = 'result-card';

            const header = document.createElement('h2');
            header.textContent = `Combination ${i + 1}`;

            const table = renderCombinationTable(combo);

            card.appendChild(header);
            card.appendChild(table);
            resultsSection.appendChild(card);
        });
    }

    // Initialize with 1 food input
    createFoodInputs();
</script>
</body>
</html>
