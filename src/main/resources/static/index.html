<!--
Save this file as index.html

To run locally:
1. In a terminal, navigate to the folder containing this file.
2. Run: python3 -m http.server 8000
3. Open http://localhost:8000 in your browser.
Ensure your backend is running on http://localhost:3000
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Amino Acid Calculator</title>
    <style>
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
            margin: 0;
            padding: 1rem;
            max-width: 1100px;
            margin-left: auto;
            margin-right: auto;
            color: #0f172a;
            background: #f8fafc;
        }
        h1 {
            text-align: center;
            margin-bottom: 1rem;
            font-weight: 700;
        }
        .form-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
            position: relative;
        }
        .form-group input,
        .form-group button {
            font-size: 1rem;
        }
        .food-input {
            flex: 1 1 100%;
            padding: 0.5rem;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
        }
        .range-input {
            width: 5.2rem;
            padding: 0.5rem;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
        }
        button {
            cursor: pointer;
            padding: 0.6rem 1rem;
            border: none;
            background: #2563eb;
            color: white;
            border-radius: 6px;
            transition: background 0.15s ease;
        }
        button:hover { background: #1d4ed8; }
        button[disabled] {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .suggestions {
            border: 1px solid #94a3b8;
            border-top: none;
            position: absolute;
            background: white;
            width: calc(100% - 2px);
            max-height: 180px;
            overflow-y: auto;
            z-index: 1000;
            border-bottom-left-radius: 6px;
            border-bottom-right-radius: 6px;
            box-shadow: 0 6px 20px rgba(15, 23, 42, 0.08);
        }
        .suggestions div {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
        }
        .suggestions div:hover {
            background: #f1f5f9;
        }
        .results {
            margin-top: 2rem;
        }
        .result-card {
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1.25rem;
            background: white;
            box-shadow: 0 6px 18px rgba(2, 8, 23, 0.03);
        }
        .result-card h2 {
            margin: 0 0 0.75rem;
            font-size: 1.1rem;
            color: #0f172a;
        }
        table.combo-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            font-variant-numeric: tabular-nums;
            border-radius: 8px;
            overflow: hidden;
        }
        table.combo-table thead th {
            position: sticky;
            top: 0;
            z-index: 1;
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
            color: #334155;
            padding: 8px 10px;
            text-align: right;
            font-weight: 700;
            font-size: 0.9rem;
        }
        table.combo-table thead th:first-child { text-align: left; }
        table.combo-table thead th:nth-child(2) { text-align: right; }
        table.combo-table tbody td,
        table.combo-table tfoot td {
            border-bottom: 1px solid #e2e8f0;
            padding: 8px 10px;
            text-align: right;
            background: transparent; /* let row background show through */
        }
        /* Remove zebra striping so the whole row can have the same color dynamically */
        /* table.combo-table tbody tr:nth-child(odd) td { background: #fbfdff; } */
        table.combo-table td.food {
            text-align: left;
            font-weight: 600;
            color: #0f172a;
        }
        table.combo-table tfoot td {
            background: #f1f5f9;
            font-weight: 700;
        }
        .chip {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            background: #e2e8f0;
            color: #0f172a;
            font-size: 0.85rem;
            margin-left: 6px;
        }
    </style>
</head>
<body>
<h1>Amino Acid Calculator</h1>
<div id="app">
    <div id="input-section">
        <div id="food-list"></div>
        <button id="add-food-btn">Add Food</button>
        <button id="calculate-btn">Calculate Combinations</button>
    </div>
    <div class="results" id="results-section"></div>
</div>
<script>
    const maxFoods = 7;
    let foodCount = 0;

    const foodListEl = document.getElementById('food-list');
    const addFoodBtn = document.getElementById('add-food-btn');
    const calculateBtn = document.getElementById('calculate-btn');
    const resultsSection = document.getElementById('results-section');

    function createFoodInputs() {
        if (foodCount >= maxFoods) return;
        const idx = foodCount++;
        const container = document.createElement('div');
        container.className = 'form-group';
        container.id = `food-group-${idx}`;

        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.placeholder = 'Type food name';
        nameInput.className = 'food-input';
        nameInput.autocomplete = 'off';
        nameInput.addEventListener('input', debounce(e => fetchSuggestions(e.target.value, idx), 300));

        const suggestionsBox = document.createElement('div');
        suggestionsBox.id = `suggestions-${idx}`;
        suggestionsBox.style.display = 'none';
        suggestionsBox.className = 'suggestions';

        const minInput = document.createElement('input');
        minInput.type = 'number';
        minInput.step = '5';
        minInput.min = '0';
        minInput.placeholder = 'Min g';
        minInput.className = 'range-input';

        const maxInput = document.createElement('input');
        maxInput.type = 'number';
        maxInput.step = '5';
        maxInput.min = '0';
        maxInput.placeholder = 'Max g';
        maxInput.className = 'range-input';

        container.append(nameInput, suggestionsBox, minInput, maxInput);
        foodListEl.appendChild(container);
    }

    addFoodBtn.addEventListener('click', createFoodInputs);

    function debounce(fn, delay) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => fn(...args), delay);
        };
    }

    async function fetchSuggestions(query, idx) {
        if (!query) {
            toggleSuggestions(idx, []);
            return;
        }
        try {
            const res = await fetch(`http://localhost:8080/api/foods?suggest=${encodeURIComponent(query)}`);
            const foods = await res.json();
            toggleSuggestions(idx, foods);
        } catch (err) {
            console.error(err);
        }
    }

    function toggleSuggestions(idx, foods) {
        const box = document.getElementById(`suggestions-${idx}`);
        box.innerHTML = '';
        if (!foods.length) {
            box.style.display = 'none';
            return;
        }
        foods.forEach(food => {
            const div = document.createElement('div');
            div.textContent = food.name;
            div.addEventListener('click', () => selectSuggestion(idx, food));
            box.appendChild(div);
        });
        box.style.display = 'block';
    }

    function selectSuggestion(idx, food) {
        const container = document.getElementById(`food-group-${idx}`);
        const nameInput = container.querySelector('input.food-input');
        nameInput.value = food.name;
        container.dataset.foodId = food.id;
        document.getElementById(`suggestions-${idx}`).style.display = 'none';
    }

    calculateBtn.addEventListener('click', async () => {
        const foods = [];
        for (let i = 0; i < foodCount; i++) {
            const container = document.getElementById(`food-group-${i}`);
            const id = container.dataset.foodId;
            const name = container.querySelector('input.food-input').value;
            const min = parseInt(container.querySelector('input[placeholder="Min g"]').value);
            const max = parseInt(container.querySelector('input[placeholder="Max g"]').value);
            if (id && name && !isNaN(min) && !isNaN(max)) {
                foods.push({ id, name, min, max });
            }
        }
        if (!foods.length) return;
        try {
            const res = await fetch('http://localhost:8080/api/calculate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ foods })
            });
            const results = await res.json();
            displayResults(results);
        } catch (err) {
            console.error(err);
        }
    });

    // Build and render a combination table from CombinationTableDto
    function renderCombinationTable(combo) {
        const table = document.createElement('table');
        table.className = 'combo-table';

        // Header: Food | Amount | Amino columns
        const thead = document.createElement('thead');
        const htr = document.createElement('tr');
        ['Food', 'Amount', ...combo.aminoColumns].forEach(label => {
            const th = document.createElement('th');
            th.textContent = label;
            htr.appendChild(th);
        });
        thead.appendChild(htr);
        table.appendChild(thead);

        // Color scale helper 0..1 => redâ†’green
        function pctColor(p) {
            const t = Math.max(0, Math.min(1, p));
            const r = Math.round(255 * (1 - t));
            const g = Math.round(180 * t);
            return `rgb(${r},${g},120)`;
        }

        // Determine baseline for row coloring using PROTEIN share
        const maxRowProtein = combo.rows.reduce((m, r) => {
            const v = r.mgByAmino['PROTEIN'] || 0;
            return Math.max(m, v);
        }, 0);

        // Body rows
        const tbody = document.createElement('tbody');
        combo.rows.forEach(row => {
            const tr = document.createElement('tr');

            // Uniform row color based on protein proportion
            const rowProtein = row.mgByAmino['PROTEIN'] || 0;
            if (maxRowProtein > 0) {
                const p = rowProtein / maxRowProtein;
                tr.style.background = pctColor(p);
            }

            // Food name
            const tdf = document.createElement('td');
            tdf.className = 'food';
            tdf.textContent = row.name;
            tr.appendChild(tdf);

            // Amount with " g"
            const tdg = document.createElement('td');
            tdg.textContent = `${row.grams} g`;
            tr.appendChild(tdg);

            // Amino/protein values in grams with " g"
            combo.aminoColumns.forEach(a => {
                const mg = row.mgByAmino[a] ?? 0;
                const grams = mg / 1000;
                const td = document.createElement('td');
                td.textContent = `${grams.toFixed(2)} g`;
                tr.appendChild(td);
            });

            tbody.appendChild(tr);
        });
        table.appendChild(tbody);

        // Totals row
        const tfoot = document.createElement('tfoot');
        const trt = document.createElement('tr');

        // First column: "Total"
        const tlabel = document.createElement('td');
        tlabel.textContent = 'Total';
        trt.appendChild(tlabel);

        // Amount column: sum of grams with " g"
        const totalGrams = combo.rows.reduce((sum, r) => sum + (r.grams || 0), 0);
        const tAmount = document.createElement('td');
        tAmount.textContent = `${totalGrams} g`;
        trt.appendChild(tAmount);

        // Amino/protein totals in grams with " g" and % of daily minimum intake
        combo.aminoColumns.forEach(a => {
            const mg = combo.totals.totalMgByAmino[a] ?? 0;
            const grams = mg / 1000;
            const rdaMg = (combo.rdaMgByAmino && combo.rdaMgByAmino[a]) ? combo.rdaMgByAmino[a] : 0;
            const pct = rdaMg > 0 ? Math.round((mg / rdaMg) * 100) : 0;
            const td = document.createElement('td');
            td.textContent = `${grams.toFixed(2)} g (${pct}%)`;
            trt.appendChild(td);
        });

        tfoot.appendChild(trt);
        table.appendChild(tfoot);

        return table;
    }

    function displayResults(results) {
        resultsSection.innerHTML = '';

        results.forEach((combo, i) => {
            const card = document.createElement('div');
            card.className = 'result-card';

            const header = document.createElement('h2');
            header.textContent = `Combination ${i + 1}`;

            const table = renderCombinationTable(combo);

            card.appendChild(header);
            card.appendChild(table);
            resultsSection.appendChild(card);
        });
    }

    // Initialize with 1 food input
    createFoodInputs();
</script>
</body>
</html>
